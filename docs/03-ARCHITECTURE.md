# 系统架构设计文档

## 架构总览

```
┌─────────────────────────────────────────────────────────────┐
│                     控制层：任务编排引擎                      │
│  (Webhook触发 → 工作流定义 → 任务调度 → 状态管理)           │
└────────────────────┬────────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────────┐
│                   执行层：CI/CD + 部署                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 代码拉取     │→ │ 构建/测试    │→ │ 打包产物    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                                              │               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────▼──────┐      │
│  │ 部署到开发   │  │ 部署到测试   │  │ 部署到生产  │      │
│  └──────────────┘  └──────────────┘  └─────────────┘      │
└────────────────────┬────────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────────┐
│                   监控层：日志 + 告警                        │
│  (构建日志 → 部署日志 → 告警规则 → 通知)                   │
└────────────────────┬────────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────────┐
│                   存储层：配置 + 产物 + 历史                 │
│  (构建配置 → 产物存储 → 部署历史 → 回滚记录)               │
└─────────────────────────────────────────────────────────────┘
```

## 核心模块设计

### 1. 控制层：任务编排引擎
**职责：** 接收Webhook事件，触发工作流，管理任务状态

**功能：**
- Webhook接收器（GitHub/GitLab推送事件）
- 工作流定义和存储（YAML配置）
- 任务队列和调度
- 状态机管理（待执行→执行中→成功/失败）

**API接口：**
```
POST /api/webhooks/github    # GitHub推送事件
POST /api/workflows          # 创建工作流
GET  /api/workflows/{id}     # 查询工作流
GET  /api/tasks/{id}         # 查询任务状态
POST /api/tasks/{id}/retry   # 重试任务
POST /api/tasks/{id}/cancel  # 取消任务
```

### 2. 执行层：CI/CD + 部署
**职责：** 执行构建、测试、部署操作

**功能：**
- 代码拉取（git clone）
- 构建执行（编译、打包）
- 测试执行（单元测试、集成测试）
- 产物生成和上传
- 多环境部署（开发/测试/生产）
- 回滚机制

**部署流程：**
```
1. 代码拉取 → git clone <repo> --branch <branch>
2. 依赖安装 → go mod download
3. 构建 → go build -o app
4. 测试 → go test ./...
5. 产物打包 → docker build -t app:v1.0.0
6. 产物上传 → docker push registry/app:v1.0.0
7. 部署 → docker-compose up -d
8. 健康检查 → curl http://localhost:8080/health
9. 回滚准备 → 保存前一版本镜像
```

### 3. 监控层：日志 + 告警
**职责：** 收集日志，监控部署状态，触发告警

**功能：**
- 构建日志收集
- 部署日志收集
- 告警规则定义（部署失败、超时等）
- 通知渠道（邮件、Slack、钉钉等）

**告警规则示例：**
```
- 构建失败 → 立即通知
- 部署失败 → 立即通知 + 自动回滚
- 部署超时（>30min） → 通知 + 手动介入
- 健康检查失败 → 立即通知 + 自动回滚
```

### 4. 存储层：配置 + 产物 + 历史
**职责：** 存储配置、产物、部署历史

**存储方案：**
- 配置：PostgreSQL（工作流定义、部署配置）
- 产物：Docker Registry（镜像存储）
- 日志：文件系统或ELK（日志存储）
- 历史：PostgreSQL（部署记录、回滚记录）

## 数据流

```
GitHub推送事件
    ↓
Webhook接收器 → 触发工作流
    ↓
任务队列 → 调度执行
    ↓
执行层：代码拉取 → 构建 → 测试 → 打包 → 部署
    ↓
监控层：收集日志 → 检查状态 → 触发告警
    ↓
存储层：保存历史 → 记录产物 → 保存配置
    ↓
用户界面：查看日志 → 查看状态 → 手动操作（重试/回滚）
```

## 部署架构

```
┌─────────────────────────────────────────┐
│         GitHub / GitLab 仓库             │
└────────────────┬────────────────────────┘
                 │ Webhook推送
┌────────────────▼────────────────────────┐
│      自动化交付系统（单VPS）             │
│  ┌──────────────────────────────────┐  │
│  │  Go应用（控制层 + 执行层）       │  │
│  │  - Webhook接收器                 │  │
│  │  - 任务调度器                    │  │
│  │  - CI/CD执行器                   │  │
│  │  - 部署管理器                    │  │
│  └──────────────────────────────────┘  │
│  ┌──────────────────────────────────┐  │
│  │  PostgreSQL（配置 + 历史）       │  │
│  └──────────────────────────────────┘  │
│  ┌──────────────────────────────────┐  │
│  │  Docker Registry（产物存储）     │  │
│  └──────────────────────────────────┘  │
│  ┌──────────────────────────────────┐  │
│  │  Docker Compose（应用编排）      │  │
│  └──────────────────────────────────┘  │
└─────────────────────────────────────────┘
                 │
    ┌────────────┼────────────┐
    ↓            ↓            ↓
┌────────┐  ┌────────┐  ┌────────┐
│ 开发环境 │  │ 测试环境 │  │ 生产环境 │
│(Docker) │  │(Docker) │  │(Docker) │
└────────┘  └────────┘  └────────┘
```

## 关键设计决策

1. **单VPS部署**：成本低，一人可维护，使用Docker Compose编排
2. **GitHub Actions触发**：无需自建CI/CD，零成本
3. **Docker容器化**：标准化部署，便于回滚
4. **PostgreSQL存储**：可靠性高，支持事务
5. **简化监控**：MVP阶段使用文件日志，后续可升级ELK

## 状态
- [ ] TechLead确认
- [ ] 架构评审通过
- [ ] 签字确认
- [ ] 冻结版本

**评审日期：** ___________
**评审人：** ___________
