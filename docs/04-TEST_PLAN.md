# 测试计划

## 测试策略

一人团队测试策略：**分层测试 + 自动化优先 + 关键路径覆盖**

```
┌─────────────────────────────────────────┐
│  E2E测试（关键路径）                     │  优先级：P1
│  - 完整部署流程测试                      │  覆盖率：20%
└─────────────────────────────────────────┘
┌─────────────────────────────────────────┐
│  集成测试（模块间交互）                  │  优先级：P0
│  - API接口测试                           │  覆盖率：60%
│  - 数据库交互测试                        │
└─────────────────────────────────────────┘
┌─────────────────────────────────────────┐
│  单元测试（核心逻辑）                    │  优先级：P0
│  - 工作流引擎测试                        │  覆盖率：80%
│  - 任务调度器测试                        │
│  - 部署管理器测试                        │
└─────────────────────────────────────────┘
```

## 测试范围

### 单元测试（P0）
**目标覆盖率：80%**

| 模块 | 测试内容 | 优先级 |
|------|---------|--------|
| 工作流引擎 | 工作流解析、状态机转换、错误处理 | P0 |
| 任务调度器 | 任务队列、并发控制、超时处理 | P0 |
| 部署管理器 | 部署流程、回滚逻辑、健康检查 | P0 |
| Webhook接收器 | 事件解析、签名验证、触发逻辑 | P0 |

**工具：** Go testing + testify

### 集成测试（P0）
**目标覆盖率：60%**

| 场景 | 测试内容 | 优先级 |
|------|---------|--------|
| API接口 | 创建工作流、查询任务、重试/取消 | P0 |
| 数据库交互 | CRUD操作、事务处理、并发安全 | P0 |
| Docker操作 | 镜像构建、容器启动、健康检查 | P0 |
| 文件系统 | 日志写入、产物存储、清理机制 | P1 |

**工具：** Go testing + testcontainers（Docker测试）

### E2E测试（P1）
**目标覆盖率：20%（关键路径）**

| 场景 | 测试内容 | 优先级 |
|------|---------|--------|
| 完整部署流程 | Webhook触发 → 构建 → 测试 → 部署 → 健康检查 | P0 |
| 部署失败回滚 | 部署失败 → 自动回滚 → 告警通知 | P0 |
| 手动重试 | 任务失败 → 手动重试 → 成功部署 | P1 |
| 多环境部署 | 开发环境 → 测试环境 → 生产环境 | P1 |

**工具：** Go testing + 真实Docker环境

## 测试环境

### 本地开发环境
```
- Go 1.21+
- Docker Desktop
- PostgreSQL（Docker容器）
- 测试用Git仓库
```

### CI环境（GitHub Actions）
```yaml
name: Test
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      - run: go test -v -race -coverprofile=coverage.txt ./...
      - run: go tool cover -html=coverage.txt -o coverage.html
```

## 测试数据

### Mock数据
- 测试用Git仓库（GitHub/GitLab）
- 测试用Webhook事件（JSON payload）
- 测试用工作流配置（YAML）
- 测试用Docker镜像

### 测试数据库
- 使用testcontainers启动临时PostgreSQL
- 每个测试用例独立数据库
- 测试结束自动清理

## 测试执行

### 本地执行
```bash
# 运行所有测试
make test

# 运行单元测试
make test-unit

# 运行集成测试
make test-integration

# 运行E2E测试
make test-e2e

# 生成覆盖率报告
make coverage
```

### CI执行
- 每次push自动触发
- PR合并前必须通过所有测试
- 覆盖率报告自动生成

## 测试时间预估

| 测试类型 | 执行时间 | 频率 |
|---------|---------|------|
| 单元测试 | 2-5分钟 | 每次提交 |
| 集成测试 | 5-10分钟 | 每次提交 |
| E2E测试 | 10-20分钟 | 每次PR |
| 全量测试 | 20-30分钟 | 每次发布 |

## 测试失败处理

### 单元测试失败
- 立即修复，不允许合并
- 修复时间：<1小时

### 集成测试失败
- 分析原因，修复或调整测试
- 修复时间：<2小时

### E2E测试失败
- 分析是否环境问题或真实bug
- 修复时间：<4小时

## 回归测试

### 触发条件
- 每次发布前
- 重大功能变更后
- 生产环境问题修复后

### 测试范围
- 全量单元测试
- 全量集成测试
- 关键路径E2E测试

## 性能测试（可选，P2）

### 测试场景
- 并发部署（10个任务同时执行）
- 大规模日志写入（1GB日志）
- 长时间运行（24小时稳定性）

### 性能指标
- 部署耗时：<10分钟
- API响应时间：<500ms
- 内存占用：<512MB
- CPU占用：<50%

## 状态
- [ ] TechLead确认
- [ ] 测试计划评审通过
- [ ] 签字确认
- [ ] 冻结版本

**评审日期：** ___________
**评审人：** ___________
