name: rollback

on:
  workflow_dispatch:
    inputs:
      reason:
        description: "Why rollback"
        required: false
        type: string

permissions:
  contents: read

jobs:
  rollback:
    runs-on: ubuntu-latest
    steps:
      - name: Rollback over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            APP_NAME=delivery-system-mvp
            mkdir -p /opt/${APP_NAME}
            curl -fsSL "https://raw.githubusercontent.com/${{ github.repository }}/master/scripts/server/rollback.sh" -o /opt/${APP_NAME}/rollback.sh
            chmod +x /opt/${APP_NAME}/rollback.sh
            /opt/${APP_NAME}/rollback.sh
            echo "Rollback done"
